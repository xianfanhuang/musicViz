<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音景 - 艺术级音乐可视化播放器</title>
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/youtube-dl-js@1.0.1/dist/youtube-dl.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',    // 靛蓝色
            secondary: '#ec4899',  // 粉红色
            dark: '#0f172a',       // 深色背景
            light: '#f8fafc',      // 浅色文本
            theme1: '#6366f1',     // 主题1主色
            theme2: '#10b981',     // 主题2主色(翡翠绿)
            theme3: '#f59e0b',     // 主题3主色(琥珀色)
            theme4: '#ec4899',     // 主题4主色(粉红色)
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .backdrop-blur-xl {
        backdrop-filter: blur(24px);
      }
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .visualizer-container {
        position: relative;
        width: 100%;
        overflow: hidden;
      }
      .progress-bar {
        height: 4px;
        cursor: pointer;
        transition: height 0.2s;
      }
      .progress-bar:hover, .progress-bar:active {
        height: 6px;
      }
      .control-btn {
        transition: all 0.2s ease;
      }
      .control-btn:hover, .control-btn:active {
        transform: scale(1.1);
      }
      .theme-btn {
        transition: all 0.3s ease;
        position: relative;
      }
      .theme-btn::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 0;
        width: 100%;
        height: 2px;
        background: inherit;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .theme-btn:hover {
        transform: scale(1.2);
      }
      .theme-btn:hover::after {
        opacity: 1;
      }
      .upload-area {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .upload-area::before {
        content: "";
        position: absolute;
        inset: -2px;
        border: 2px dashed transparent;
        border-radius: inherit;
        background: linear-gradient(90deg, #6366f1, #ec4899, #6366f1);
        background-size: 200% 200%;
        animation: borderAnimate 3s linear infinite;
        pointer-events: none;
        opacity: 0;
      }
      .upload-area.drag-over {
        background-color: rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.8);
      }
      .upload-area.drag-over::before {
        opacity: 1;
      }
      @keyframes borderAnimate {
        0% { background-position: 0% 50%; }
        100% { background-position: 200% 50%; }
      }
      /* 音频波形加载动画 */
      @keyframes waveAnimate {
        0%, 100% { transform: scaleY(0.3); }
        50% { transform: scaleY(1); }
      }
      .wave-bar {
        animation: waveAnimate 1.5s ease-in-out infinite;
        transform-origin: bottom;
      }
    }
  </style>
</head>

<body class="bg-dark text-light font-inter min-h-screen flex flex-col">
  <!-- 粒子背景装饰 -->
  <div class="fixed inset-0 pointer-events-none z-0">
    <div id="particleBackground" class="absolute inset-0"></div>
  </div>

  <!-- 顶部导航 -->
  <header class="bg-dark/70 backdrop-blur-xl border-b border-slate-800/50 py-4 px-6 relative z-10">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center shadow-lg shadow-primary/20">
          <i class="fa fa-music text-white text-xl"></i>
        </div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary text-gradient">音景</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <button id="fullscreenBtn" class="p-2 rounded-full hover:bg-slate-800/50 transition-colors control-btn">
          <i class="fa fa-expand"></i>
        </button>
        <a href="https://github.com" target="_blank" class="hidden md:flex items-center gap-2 bg-slate-800/50 hover:bg-slate-700/50 px-4 py-2 rounded-full transition-colors">
          <i class="fa fa-github"></i>
          <span>GitHub</span>
        </a>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 container mx-auto px-4 py-6 relative z-10">
    <div class="max-w-6xl mx-auto">
      <!-- 可视化区域 -->
      <div class="visualizer-container bg-gradient-to-br from-dark to-slate-900 rounded-2xl mb-6 overflow-hidden border border-slate-800/50 shadow-xl">
        <canvas id="visualizer" class="w-full aspect-video"></canvas>
        
        <!-- 加载状态 -->
        <div id="loadingIndicator" class="absolute inset-0 bg-dark/80 flex items-center justify-center hidden">
          <div class="text-center">
            <div class="w-24 h-12 flex items-end justify-center gap-1 mb-4">
              <!-- 动态波形加载 -->
              <div class="wave-bar w-3 h-6 bg-theme1 rounded-t" style="animation-delay: 0.1s"></div>
              <div class="wave-bar w-3 h-10 bg-theme1/80 rounded-t" style="animation-delay: 0.2s"></div>
              <div class="wave-bar w-3 h-4 bg-theme1/60 rounded-t" style="animation-delay: 0.3s"></div>
              <div class="wave-bar w-3 h-8 bg-theme1/70 rounded-t" style="animation-delay: 0.4s"></div>
              <div class="wave-bar w-3 h-5 bg-theme1/50 rounded-t" style="animation-delay: 0.5s"></div>
              <div class="wave-bar w-3 h-9 bg-theme1/90 rounded-t" style="animation-delay: 0.6s"></div>
              <div class="wave-bar w-3 h-3 bg-theme1/40 rounded-t" style="animation-delay: 0.7s"></div>
            </div>
            <p id="loadingText" class="text-lg">处理音频中...</p>
          </div>
        </div>
        
        <!-- 初始提示 -->
        <div id="initialMessage" class="absolute inset-0 bg-gradient-to-br from-dark/80 to-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6">
          <i class="fa fa-music text-6xl bg-gradient-to-r from-primary to-secondary text-gradient mb-6 animate-pulse"></i>
          <h2 class="text-2xl font-bold mb-2">音乐可视化体验</h2>
          <p class="text-slate-300 mb-6 max-w-md">上传音乐文件、输入音频URL或视频网站链接，沉浸在音乐与视觉的融合艺术中</p>
          
          <!-- 上传区域 -->
          <div id="uploadArea" class="upload-area border-2 border-dashed border-slate-600 rounded-xl p-8 w-full max-w-md cursor-pointer">
            <div class="text-center">
              <i class="fa fa-upload text-3xl bg-gradient-to-r from-primary to-secondary text-gradient mb-4"></i>
              <p class="mb-2">点击或拖拽音频文件到此处</p>
              <p class="text-sm text-slate-400">支持 MP3, WAV, FLAC 等格式</p>
              <input type="file" id="fileInput" accept="audio/*" class="hidden">
              
              <!-- 上传按钮 -->
              <button id="mobileUploadBtn" class="mt-6 bg-gradient-to-r from-primary to-secondary hover:opacity-90 text-white px-6 py-3 rounded-full text-sm transition-all shadow-lg shadow-primary/20">
                <i class="fa fa-file-audio-o mr-2"></i>选择音频文件
              </button>
            </div>
          </div>
        </div>
        
        <!-- 错误提示 -->
        <div id="errorMessage" class="absolute inset-0 bg-dark/90 flex flex-col items-center justify-center text-center p-6 hidden">
          <i class="fa fa-exclamation-triangle text-5xl text-amber-500 mb-4"></i>
          <h3 class="text-xl font-bold mb-2">无法加载音频</h3>
          <p id="errorDetails" class="text-slate-300 mb-6 max-w-md">请尝试其他音频文件或检查网络连接</p>
          <button id="retryBtn" class="bg-gradient-to-r from-primary to-secondary hover:opacity-90 text-white px-6 py-3 rounded-full transition-all shadow-lg shadow-primary/20">
            重试
          </button>
        </div>
      </div>
      
      <!-- 音频信息和控制 -->
      <div class="bg-slate-800/30 backdrop-blur-xl rounded-2xl p-5 border border-slate-700/30 mb-6 shadow-lg">
        <!-- 音频信息 -->
        <div class="mb-5">
          <h2 id="trackTitle" class="text-xl font-bold mb-1 truncate">未选择音频</h2>
          <!-- 音频属性标签 -->
          <div class="flex flex-wrap gap-2 mb-1">
            <span id="trackBitrate" class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded-full hidden"></span>
            <span id="trackSampleRate" class="text-xs bg-secondary/20 text-secondary px-2 py-0.5 rounded-full hidden"></span>
          </div>
          <p id="trackInfo" class="text-slate-400 text-sm">请上传音频文件或输入URL</p>
        </div>
        
        <!-- 进度条 -->
        <div class="mb-4">
          <div class="flex justify-between text-sm text-slate-400 mb-1">
            <span id="currentTime">00:00</span>
            <span id="totalTime">00:00</span>
          </div>
          <div class="bg-slate-700/50 rounded-full overflow-hidden progress-bar">
            <div id="progressBar" class="h-full w-0 bg-gradient-to-r from-primary to-secondary"></div>
          </div>
        </div>
        
        <!-- 控制按钮 -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center gap-4 sm:gap-6">
            <button id="shuffleBtn" class="control-btn text-slate-400 hover:text-white p-2">
              <i class="fa fa-random text-lg sm:text-xl"></i>
            </button>
            <button id="prevBtn" class="control-btn text-slate-400 hover:text-white p-2">
              <i class="fa fa-step-backward text-lg sm:text-xl"></i>
            </button>
            <button id="playPauseBtn" class="control-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white shadow-lg shadow-primary/30">
              <i class="fa fa-play text-xl sm:text-2xl"></i>
            </button>
            <button id="nextBtn" class="control-btn text-slate-400 hover:text-white p-2">
              <i class="fa fa-step-forward text-lg sm:text-xl"></i>
            </button>
            <button id="loopBtn" class="control-btn text-slate-400 hover:text-white p-2">
              <i class="fa fa-repeat text-lg sm:text-xl"></i>
            </button>
          </div>
          
          <div class="flex items-center gap-3">
            <button class="control-btn text-slate-400 hover:text-white p-2">
              <i class="fa fa-volume-up text-lg sm:text-xl"></i>
            </button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.7" class="w-24 sm:w-28 accent-primary">
          </div>
        </div>
      </div>
      
      <!-- 可视化控制 -->
      <div class="bg-slate-800/30 backdrop-blur-xl rounded-2xl p-5 border border-slate-700/30 shadow-lg">
        <h3 class="text-lg font-semibold mb-5 bg-gradient-to-r from-primary to-secondary text-gradient">可视化设置</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- 可视化模式选择 -->
          <div>
            <label class="block text-sm text-slate-300 mb-3">可视化模式</label>
            <div class="flex flex-wrap gap-2">
              <button data-visualization="waveform" class="visualization-btn bg-primary text-white text-sm px-3 py-1.5 rounded-full shadow-md shadow-primary/20">波形图</button>
              <button data-visualization="bars" class="visualization-btn bg-slate-700/50 hover:bg-slate-600 text-white text-sm px-3 py-1.5 rounded-full transition-colors">频谱柱</button>
              <button data-visualization="particles" class="visualization-btn bg-slate-700/50 hover:bg-slate-600 text-white text-sm px-3 py-1.5 rounded-full transition-colors">粒子</button>
              <button data-visualization="circular" class="visualization-btn bg-slate-700/50 hover:bg-slate-600 text-white text-sm px-3 py-1.5 rounded-full transition-colors">圆形</button>
            </div>
          </div>
          
          <!-- 主题选择 -->
          <div>
            <label class="block text-sm text-slate-300 mb-3">颜色主题</label>
            <div class="flex gap-3">
              <button data-theme="theme1" class="theme-btn w-10 h-10 rounded-full bg-gradient-to-r from-theme1 to-purple-400 border-2 border-white"></button>
              <button data-theme="theme2" class="theme-btn w-10 h-10 rounded-full bg-gradient-to-r from-theme2 to-teal-400 border-2 border-transparent hover:border-white/50"></button>
              <button data-theme="theme3" class="theme-btn w-10 h-10 rounded-full bg-gradient-to-r from-theme3 to-orange-400 border-2 border-transparent hover:border-white/50"></button>
              <button data-theme="theme4" class="theme-btn w-10 h-10 rounded-full bg-gradient-to-r from-theme4 to-pink-400 border-2 border-transparent hover:border-white/50"></button>
            </div>
          </div>
          
          <!-- 音频URL输入 -->
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-300 mb-3">
              音频/视频URL 
              <span class="text-xs text-primary ml-2">(支持YouTube、B站等1000+站点)</span>
            </label>
            <div class="flex gap-2">
              <input type="text" id="audioUrl" placeholder="输入音频/视频URL..." class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary transition-colors">
              <button id="loadUrlBtn" class="bg-gradient-to-r from-primary to-secondary hover:opacity-90 text-white px-3 py-2 rounded-lg text-sm transition-all shadow-md shadow-primary/20">
                加载
              </button>
            </div>
          </div>
          
          <!-- 动画速度 -->
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-300 mb-3">动画速度</label>
            <input type="range" id="animationSpeed" min="0.5" max="3" step="0.1" value="1" class="w-full accent-primary">
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark/70 backdrop-blur-xl border-t border-slate-800/50 py-5 px-6 mt-6 relative z-10">
    <div class="container mx-auto text-center text-slate-400 text-sm">
      <p>音景 - 艺术级音乐可视化播放器 &copy; 2023</p>
      <p class="mt-1">融合Web Audio API与视觉艺术的沉浸式体验</p>
    </div>
  </footer>

  <!-- 音频元素（隐藏） -->
  <audio id="audioElement" hidden></audio>

  <!-- JavaScript -->
  <script>
    // DOM 元素
    const audioElement = document.getElementById('audioElement');
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const mobileUploadBtn = document.getElementById('mobileUploadBtn');
    const initialMessage = document.getElementById('initialMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingText = document.getElementById('loadingText');
    const errorMessage = document.getElementById('errorMessage');
    const errorDetails = document.getElementById('errorDetails');
    const retryBtn = document.getElementById('retryBtn');
    const visualizerCanvas = document.getElementById('visualizer');
    const visualizerCtx = visualizerCanvas.getContext('2d');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const progressBar = document.getElementById('progressBar');
    const currentTimeDisplay = document.getElementById('currentTime');
    const totalTimeDisplay = document.getElementById('totalTime');
    const volumeSlider = document.getElementById('volumeSlider');
    const trackTitle = document.getElementById('trackTitle');
    const trackInfo = document.getElementById('trackInfo');
    const trackBitrate = document.getElementById('trackBitrate');
    const trackSampleRate = document.getElementById('trackSampleRate');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const audioUrlInput = document.getElementById('audioUrl');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const animationSpeedSlider = document.getElementById('animationSpeed');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const loopBtn = document.getElementById('loopBtn');
    const particleBackground = document.getElementById('particleBackground');
    
    // 可视化相关变量
    let audioContext;
    let analyser;
    let dataArray;
    let animationId;
    let isPlaying = false;
    let currentVisualization = 'waveform';
    let currentTheme = 'theme1';
    let themeColors = {
      theme1: ['#6366f1', '#8b5cf6'],
      theme2: ['#10b981', '#34d399'],
      theme3: ['#f59e0b', '#fbbf24'],
      theme4: ['#ec4899', '#f472b6']
    };
    let backgroundParticles = [];
    let currentFile = null;
    
    // 支持的音频格式
    const supportedFormats = [
      'audio/mpeg',    // MP3
      'audio/wav',     // WAV
      'audio/flac',    // FLAC
      'audio/aac',     // AAC
      'audio/ogg',     // OGG
      'audio/mp4',     // M4A
      'audio/x-m4a'    // M4A 替代类型
    ];
    
    // 创建背景粒子
    function createBackgroundParticles() {
      const particleCount = 30;
      backgroundParticles = [];
      
      for (let i = 0; i < particleCount; i++) {
        const size = Math.random() * 3 + 1;
        backgroundParticles.push({
          x: Math.random() * window.innerWidth,
          y: Math.random() * window.innerHeight,
          size: size,
          speedX: (Math.random() - 0.5) * 0.3,
          speedY: (Math.random() - 0.5) * 0.3,
          opacity: Math.random() * 0.2 + 0.1,
          color: themeColors[currentTheme][Math.floor(Math.random() * 2)]
        });
      }
      
      drawParticles();
    }
    
    // 绘制背景粒子
    function drawParticles() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 更新粒子位置
      backgroundParticles.forEach(particle => {
        particle.x += particle.speedX;
        particle.y += particle.speedY;
        
        // 边界检查
        if (particle.x < 0 || particle.x > canvas.width) particle.speedX *= -1;
        if (particle.y < 0 || particle.y > canvas.height) particle.speedY *= -1;
        
        // 绘制粒子
        ctx.beginPath();
        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
        ctx.fillStyle = `${particle.color}${Math.floor(particle.opacity * 255).toString(16).padStart(2, '0')}`;
        ctx.fill();
      });
      
      particleBackground.style.backgroundImage = `url(${canvas.toDataURL()})`;
      requestAnimationFrame(drawParticles);
    }
    
    // 初始化画布尺寸
    function resizeCanvas() {
      const container = visualizerCanvas.parentElement;
      const rect = container.getBoundingClientRect();
      visualizerCanvas.width = rect.width;
      visualizerCanvas.height = rect.height;
      
      // 调整粒子背景尺寸
      if (particleBackground) {
        createBackgroundParticles();
      }
      
      // 如果分析器已初始化，重新设置缓冲区大小
      if (analyser) {
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
      }
    }
    
    // 监听窗口大小变化，调整画布尺寸
    window.addEventListener('resize', resizeCanvas);
    
    // 初始化音频上下文和分析器
    function initAudioContext() {
      if (audioContext) return;
      
      try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        const source = audioContext.createMediaElementSource(audioElement);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
      } catch (e) {
        console.error('Web Audio API 初始化失败:', e);
        showError('您的浏览器不支持Web Audio API，无法使用可视化功能。');
      }
    }
    
    // 格式化时间（秒 -> mm:ss）
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 更新进度条和时间显示
    function updateProgress() {
      if (isNaN(audioElement.duration)) return;
      
      const progress = (audioElement.currentTime / audioElement.duration) * 100;
      progressBar.style.width = `${progress}%`;
      currentTimeDisplay.textContent = formatTime(audioElement.currentTime);
      totalTimeDisplay.textContent = formatTime(audioElement.duration);
    }
    
    // 播放/暂停切换
    function togglePlayPause() {
      if (!audioElement.src) return;
      
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      if (isPlaying) {
        audioElement.pause();
        playPauseBtn.innerHTML = '<i class="fa fa-play text-xl sm:text-2xl"></i>';
        cancelAnimationFrame(animationId);
      } else {
        audioElement.play()
          .then(() => {
            playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl sm:text-2xl"></i>';
            visualize();
          })
          .catch(error => {
            console.error('播放失败:', error);
            showError('播放失败，请尝试其他音频文件。');
          });
      }
      
      isPlaying = !isPlaying;
    }
    
    // 跳转到音频的特定位置
    function seekAudio(e) {
      if (!audioElement.src) return;
      
      const progressBar = document.querySelector('.progress-bar');
      const rect = progressBar.getBoundingClientRect();
      const pos = (e.clientX || (e.touches && e.touches[0].clientX) - rect.left) / rect.width;
      audioElement.currentTime = pos * audioElement.duration;
    }
    
    // 设置音量
    function setVolume() {
      audioElement.volume = volumeSlider.value;
    }
    
    // 验证文件格式
    function isValidAudioFile(file) {
      // 检查MIME类型
      if (supportedFormats.includes(file.type)) {
        return true;
      }
      
      // 检查文件扩展名作为备选方案
      const ext = file.name.split('.').pop().toLowerCase();
      const validExtensions = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'];
      return validExtensions.includes(ext);
    }
    
    // 显示错误信息
    function showError(message) {
      loadingIndicator.classList.add('hidden');
      initialMessage.classList.add('hidden');
      errorDetails.textContent = message;
      errorMessage.classList.remove('hidden');
    }
    
    // 隐藏错误信息
    function hideError() {
      errorMessage.classList.add('hidden');
    }
    
    // 加载音频文件
    function loadAudioFile(file) {
      if (!file) return;
      
      currentFile = file;
      
      // 验证文件类型
      if (!isValidAudioFile(file)) {
        showError('不支持的文件格式。请上传MP3、WAV、FLAC、AAC、OGG或M4A格式的音频文件。');
        return;
      }
      
      // 显示加载指示器
      hideError();
      loadingIndicator.classList.remove('hidden');
      loadingText.textContent = '处理音频文件中...';
      initialMessage.classList.add('hidden');
      
      try {
        // 读取并加载音频文件
        const fileURL = URL.createObjectURL(file);
        audioElement.src = fileURL;
        
        // 更新轨道信息
        trackTitle.textContent = file.name;
        trackInfo.textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB · ${file.type || '音频文件'}`;
        
        // 隐藏属性标签，等待加载完成后显示
        trackBitrate.classList.add('hidden');
        trackSampleRate.classList.add('hidden');
        
        // 准备播放
        audioElement.onloadedmetadata = () => {
          loadingIndicator.classList.add('hidden');
          totalTimeDisplay.textContent = formatTime(audioElement.duration);
          
          // 初始化音频上下文
          initAudioContext();
          
          // 计算并显示音频属性
          if (file.size && audioElement.duration) {
            const bitrate = Math.round((file.size * 8) / (audioElement.duration * 1024));
            trackBitrate.textContent = `${bitrate} kbps`;
            trackBitrate.classList.remove('hidden');
          }
          
          if (audioContext) {
            const sampleRate = (audioContext.sampleRate / 1000).toFixed(1);
            trackSampleRate.textContent = `${sampleRate} kHz`;
            trackSampleRate.classList.remove('hidden');
          }
          
          // 自动播放
          if (!isPlaying) {
            togglePlayPause();
          }
        };
        
        audioElement.onerror = () => {
          loadingIndicator.classList.add('hidden');
          showError('无法加载音频文件，请尝试其他文件。');
        };
      } catch (error) {
        console.error('加载音频文件时出错:', error);
        loadingIndicator.classList.add('hidden');
        showError('处理音频文件时出错，请重试。');
      }
    }
    
    // 使用youtube-dl-js解析URL并提取音频
    async function extractAudioFromUrl(url) {
      try {
        // 显示解析中状态
        loadingText.textContent = '解析URL中...';
        
        // 调用youtube-dl-js获取视频信息
        const info = await youtubeDl.getInfo(url);
        
        // 寻找最佳音频流
        loadingText.textContent = '寻找最佳音频流...';
        let bestAudio = null;
        let highestBitrate = 0;
        
        // 遍历所有格式，找到最佳音频流
        for (const format of info.formats) {
          if (format.acodec !== 'none' && format.vcodec === 'none') { // 纯音频流
            const bitrate = parseInt(format.abr) || 0;
            if (bitrate > highestBitrate) {
              highestBitrate = bitrate;
              bestAudio = format;
            }
          }
        }
        
        // 如果没有找到纯音频流，尝试找包含音频的视频流
        if (!bestAudio) {
          for (const format of info.formats) {
            if (format.acodec !== 'none') {
              const bitrate = parseInt(format.abr) || 0;
              if (bitrate > highestBitrate) {
                highestBitrate = bitrate;
                bestAudio = format;
              }
            }
          }
        }
        
        if (bestAudio) {
          return {
            url: bestAudio.url,
            title: info.title || '来自URL的音频',
            source: new URL(url).hostname,
            bitrate: highestBitrate
          };
        } else {
          throw new Error('未找到可用的音频流');
        }
      } catch (error) {
        console.error('URL解析失败:', error);
        throw error;
      }
    }
    
    // 从URL加载音频（支持直接音频URL和视频网站URL）
    async function loadAudioFromURL(url) {
      if (!url) return;
      
      currentFile = null;
      
      // 显示加载指示器
      hideError();
      loadingIndicator.classList.remove('hidden');
      loadingText.textContent = '准备加载...';
      initialMessage.classList.add('hidden');
      
      try {
        let audioUrl, title, source, bitrate;
        
        // 检查是否是直接的音频URL
        const audioExtensions = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'];
        const urlExt = url.split('.').pop().split('?')[0].toLowerCase();
        
        if (audioExtensions.includes(urlExt)) {
          // 直接音频URL
          audioUrl = url;
          title = '来自URL的音频';
          source = new URL(url).hostname;
          bitrate = 0;
        } else {
          // 使用youtube-dl-js解析视频URL
          const result = await extractAudioFromUrl(url);
          audioUrl = result.url;
          title = result.title;
          source = result.source;
          bitrate = result.bitrate;
        }
        
        // 加载提取到的音频URL
        loadingText.textContent = '加载音频中...';
        audioElement.src = audioUrl;
        
        // 更新轨道信息
        trackTitle.textContent = title;
        trackInfo.textContent = source;
        
        // 隐藏属性标签，等待加载完成后显示
        trackBitrate.classList.add('hidden');
        trackSampleRate.classList.add('hidden');
        
        // 准备播放
        audioElement.onloadedmetadata = () => {
          loadingIndicator.classList.add('hidden');
          totalTimeDisplay.textContent = formatTime(audioElement.duration);
          
          // 初始化音频上下文
          initAudioContext();
          
          // 显示音频属性
          if (bitrate) {
            trackBitrate.textContent = `${bitrate} kbps`;
            trackBitrate.classList.remove('hidden');
          }
          
          if (audioContext) {
            const sampleRate = (audioContext.sampleRate / 1000).toFixed(1);
            trackSampleRate.textContent = `${sampleRate} kHz`;
            trackSampleRate.classList.remove('hidden');
          }
          
          // 自动播放
          if (!isPlaying) {
            togglePlayPause();
          }
        };
        
        audioElement.onerror = () => {
          loadingIndicator.classList.add('hidden');
          showError('无法加载音频，请检查URL是否正确或尝试其他链接。');
        };
      } catch (error) {
        console.error('从URL加载音频时出错:', error);
        loadingIndicator.classList.add('hidden');
        showError(`解析失败: ${error.message || '无法处理该URL'}`);
      }
    }
    
    // 切换可视化模式
    function setVisualization(mode) {
      currentVisualization = mode;
      
      // 更新按钮样式
      document.querySelectorAll('.visualization-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'shadow-md', 'shadow-primary/20');
        btn.classList.add('bg-slate-700/50', 'hover:bg-slate-600');
      });
      
      const activeBtn = document.querySelector(`[data-visualization="${mode}"]`);
      activeBtn.classList.remove('bg-slate-700/50', 'hover:bg-slate-600');
      activeBtn.classList.add('bg-primary', 'shadow-md', 'shadow-primary/20');
      
      // 如果正在播放，重新启动可视化
      if (isPlaying) {
        cancelAnimationFrame(animationId);
        visualize();
      }
    }
    
    // 切换主题
    function setTheme(theme) {
      currentTheme = theme;
      
      // 更新按钮样式
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('border-white');
        btn.classList.add('border-transparent', 'hover:border-white/50');
      });
      
      const activeBtn = document.querySelector(`[data-theme="${theme}"]`);
      activeBtn.classList.remove('border-transparent', 'hover:border-white/50');
      activeBtn.classList.add('border-white');
      
      // 更新背景粒子颜色
      backgroundParticles.forEach(particle => {
        particle.color = themeColors[currentTheme][Math.floor(Math.random() * 2)];
      });
    }
    
    // 切换全屏模式
    function toggleFullscreen() {
      const visualizerContainer = visualizerCanvas.parentElement;
      
      if (!document.fullscreenElement) {
        if (visualizerContainer.requestFullscreen) {
          visualizerContainer.requestFullscreen();
        } else if (visualizerContainer.webkitRequestFullscreen) {
          visualizerContainer.webkitRequestFullscreen();
        } else if (visualizerContainer.msRequestFullscreen) {
          visualizerContainer.msRequestFullscreen();
        }
        fullscreenBtn.innerHTML = '<i class="fa fa-compress"></i>';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i>';
      }
    }
    
    // 切换随机播放
    function toggleShuffle() {
      shuffleBtn.classList.toggle('text-primary');
      shuffleBtn.classList.toggle('text-slate-400');
    }
    
    // 切换循环模式
    function toggleLoop() {
      audioElement.loop = !audioElement.loop;
      loopBtn.classList.toggle('text-primary');
      loopBtn.classList.toggle('text-slate-400');
    }
    
    // 波形图可视化
    function visualizeWaveform() {
      const width = visualizerCanvas.width;
      const height = visualizerCanvas.height;
      
      analyser.getByteTimeDomainData(dataArray);
      
      // 半透明背景，创建轨迹效果
      visualizerCtx.fillStyle = 'rgba(15, 23, 42, 0.3)';
      visualizerCtx.fillRect(0, 0, width, height);
      
      // 第一条波形：渐变线条+发光
      visualizerCtx.lineWidth = 3;
      const gradient1 = visualizerCtx.createLinearGradient(0, 0, width, 0);
      gradient1.addColorStop(0, themeColors[currentTheme][0]);
      gradient1.addColorStop(1, themeColors[currentTheme][1]);
      visualizerCtx.strokeStyle = gradient1;
      visualizerCtx.shadowColor = themeColors[currentTheme][0];
      visualizerCtx.shadowBlur = 8;
      
      // 绘制波形路径
      visualizerCtx.beginPath();
      const sliceWidth = width / dataArray.length;
      let x = 0;
      
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * height / 2;
        
        if (i === 0) {
          visualizerCtx.moveTo(x, y);
        } else {
          visualizerCtx.lineTo(x, y);
        }
        
        x += sliceWidth;
      }
      
      visualizerCtx.lineTo(width, height / 2);
      visualizerCtx.stroke();
      
      // 波形顶点粒子
      visualizerCtx.shadowBlur = 0;
      visualizerCtx.fillStyle = themeColors[currentTheme][0];
      x = 0;
      
      for (let i = 0; i < dataArray.length; i += 10) {
        const v = dataArray[i] / 128.0;
        const y = v * height / 2;
        const particleSize = 2 + Math.sin(v * Math.PI) * 2;
        
        visualizerCtx.beginPath();
        visualizerCtx.arc(x, y, particleSize, 0, Math.PI * 2);
        visualizerCtx.fill();
        
        x += sliceWidth * 10;
      }
      
      // 第二条波形线，增加视觉效果
      visualizerCtx.lineWidth = 1;
      visualizerCtx.strokeStyle = themeColors[currentTheme][1];
      visualizerCtx.shadowBlur = 4;
      visualizerCtx.beginPath();
      
      x = 0;
      
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * height / 2 + 20;
        
        if (i === 0) {
          visualizerCtx.moveTo(x, y);
        } else {
          visualizerCtx.lineTo(x, y);
        }
        
        x += sliceWidth;
      }
      
      visualizerCtx.lineTo(width, height / 2 + 20);
      visualizerCtx.stroke();
    }
    
    // 频谱柱状图可视化
    function visualizeBars() {
      const width = visualizerCanvas.width;
      const height = visualizerCanvas.height;
      
      analyser.getByteFrequencyData(dataArray);
      
      // 半透明背景，创建平滑动画效果
      visualizerCtx.fillStyle = 'rgba(15, 23, 42, 0.3)';
      visualizerCtx.fillRect(0, 0, width, height);
      
      const barWidth = (width / dataArray.length) * 2.5;
      let x = 0;
      
      // 减少柱子数量，增强层次感
      for (let i = 0; i < dataArray.length; i += 2) {
        const barHeight = (dataArray[i] / 255) * height * animationSpeedSlider.value;
        const barY = height - barHeight;
        
        // 3D渐变：顶部亮、底部暗
        const gradient = visualizerCtx.createLinearGradient(0, barY, 0, height);
        gradient.addColorStop(0, themeColors[currentTheme][0]);
        gradient.addColorStop(0.7, themeColors[currentTheme][1]);
        gradient.addColorStop(1, `${themeColors[currentTheme][1]}20`);
        
        visualizerCtx.fillStyle = gradient;
        
        // 顶部圆角
        visualizerCtx.beginPath();
        visualizerCtx.roundRect(x, barY, barWidth, barHeight, barWidth / 2);
        visualizerCtx.fill();
        
        // 底部阴影
        visualizerCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        visualizerCtx.fillRect(x, height - 2, barWidth, 2);
        
        x += barWidth + 3;
      }
    }
    
    // 粒子效果可视化
    function visualizeParticles() {
      const width = visualizerCanvas.width;
      const height = visualizerCanvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      
      analyser.getByteFrequencyData(dataArray);
      
      // 半透明背景，创建轨迹效果
      visualizerCtx.fillStyle = 'rgba(15, 23, 42, 0.2)';
      visualizerCtx.fillRect(0, 0, width, height);
      
      const particleCount = 64;
      const angleStep = (Math.PI * 2) / particleCount;
      
      for (let i = 0; i < particleCount; i++) {
        // 从频谱数据中获取能量
        const energy = dataArray[i * 4] / 255;
        const size = 2 + energy * 8;
        const distance = 50 + energy * 150 * animationSpeedSlider.value;
        
        // 计算粒子位置
        const angle = angleStep * i + (Date.now() * 0.0005 * animationSpeedSlider.value);
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;
        
        // 绘制粒子
        visualizerCtx.beginPath();
        visualizerCtx.arc(x, y, size, 0, Math.PI * 2);
        visualizerCtx.fillStyle = themeColors[currentTheme][0];
        visualizerCtx.fill();
        
        // 绘制粒子轨迹
        visualizerCtx.beginPath();
        visualizerCtx.arc(centerX, centerY, distance, angle, angle + angleStep * 0.8);
        visualizerCtx.strokeStyle = `${themeColors[currentTheme][1]}80`;
        visualizerCtx.lineWidth = size * 0.5;
        visualizerCtx.stroke();
      }
    }
    
    // 圆形可视化
    function visualizeCircular() {
      const width = visualizerCanvas.width;
      const height = visualizerCanvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const maxRadius = Math.min(width, height) / 2 - 20;
      
      analyser.getByteFrequencyData(dataArray);
      
      // 半透明背景，创建平滑动画效果
      visualizerCtx.fillStyle = 'rgba(15, 23, 42, 0.3)';
      visualizerCtx.fillRect(0, 0, width, height);
      
      // 绘制同心圆
      const rings = 5;
      for (let r = 0; r < rings; r++) {
        const radius = (maxRadius / rings) * (r + 1);
        const energyIndex = Math.floor((dataArray.length / rings) * (r + 1));
        const energy = dataArray[energyIndex] / 255;
        
        // 根据能量调整半径和透明度
        const adjustedRadius = radius + energy * 20;
        const alpha = 0.3 + energy * 0.7;
        
        visualizerCtx.beginPath();
        visualizerCtx.arc(centerX, centerY, adjustedRadius, 0, Math.PI * 2);
        visualizerCtx.strokeStyle = `${themeColors[currentTheme][0]}${Math.floor(alpha * 255).toString(16).padStart(2, '0')}`;
        visualizerCtx.lineWidth = 2;
        visualizerCtx.stroke();
      }
      
      // 绘制放射状线条
      const lines = 64;
      const angleStep = (Math.PI * 2) / lines;
      
      for (let i = 0; i < lines; i++) {
        const angle = angleStep * i;
        const energy = dataArray[i * 2] / 255;
        const lineLength = maxRadius * energy * animationSpeedSlider.value;
        
        const x1 = centerX;
        const y1 = centerY;
        const x2 = centerX + Math.cos(angle) * lineLength;
        const y2 = centerY + Math.sin(angle) * lineLength;
        
        // 线条渐变
        const gradient = visualizerCtx.createLinearGradient(x1, y1, x2, y2);
        gradient.addColorStop(0, `${themeColors[currentTheme][0]}40`);
        gradient.addColorStop(1, themeColors[currentTheme][1]);
        
        visualizerCtx.beginPath();
        visualizerCtx.moveTo(x1, y1);
        visualizerCtx.lineTo(x2, y2);
        visualizerCtx.strokeStyle = gradient;
        visualizerCtx.lineWidth = 2;
        visualizerCtx.stroke();
        
        // 线条末端粒子
        visualizerCtx.beginPath();
        visualizerCtx.arc(x2, y2, 3 + energy * 5, 0, Math.PI * 2);
        visualizerCtx.fillStyle = themeColors[currentTheme][1];
        visualizerCtx.fill();
      }
    }
    
    // 主可视化函数
    function visualize() {
      if (!analyser) return;
      
      // 根据当前选择的可视化模式绘制
      switch (currentVisualization) {
        case 'waveform':
          visualizeWaveform();
          break;
        case 'bars':
          visualizeBars();
          break;
        case 'particles':
          visualizeParticles();
          break;
        case 'circular':
          visualizeCircular();
          break;
      }
      
      // 继续动画循环
      animationId = requestAnimationFrame(visualize);
    }
    
    // 事件监听器
    playPauseBtn.addEventListener('click', togglePlayPause);
    
    // 支持触摸和鼠标事件
    const progressBarContainer = document.querySelector('.progress-bar');
    progressBarContainer.addEventListener('click', seekAudio);
    progressBarContainer.addEventListener('touchstart', (e) => {
      e.preventDefault();
      seekAudio(e);
    });
    
    audioElement.addEventListener('timeupdate', updateProgress);
    volumeSlider.addEventListener('input', setVolume);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    loadUrlBtn.addEventListener('click', () => loadAudioFromURL(audioUrlInput.value));
    shuffleBtn.addEventListener('click', toggleShuffle);
    loopBtn.addEventListener('click', toggleLoop);
    retryBtn.addEventListener('click', () => {
      hideError();
      initialMessage.classList.remove('hidden');
    });
    
    // 音频结束时重置播放状态
    audioElement.addEventListener('ended', () => {
      isPlaying = false;
      playPauseBtn.innerHTML = '<i class="fa fa-play text-xl sm:text-2xl"></i>';
      cancelAnimationFrame(animationId);
    });
    
    // 移动端专用上传按钮
    mobileUploadBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      fileInput.click();
    });
    
    // 上传区域点击事件
    uploadArea.addEventListener('click', () => fileInput.click());
    
    // 文件选择事件
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        loadAudioFile(e.target.files[0]);
      }
    });
    
    // 拖放功能
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      
      if (e.dataTransfer.files.length > 0) {
        loadAudioFile(e.dataTransfer.files[0]);
      }
    });
    
    // 触摸设备上的拖放模拟
    let touchDragging = false;
    uploadArea.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        touchDragging = true;
      }
    });
    
    uploadArea.addEventListener('touchmove', (e) => {
      if (touchDragging) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      }
    });
    
    uploadArea.addEventListener('touchend', (e) => {
      touchDragging = false;
      uploadArea.classList.remove('drag-over');
    });
    
    // 可视化模式选择
    document.querySelectorAll('.visualization-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setVisualization(btn.dataset.visualization);
      });
    });
    
    // 主题选择
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setTheme(btn.dataset.theme);
      });
    });
    
    // URL输入框回车事件
    audioUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loadAudioFromURL(audioUrlInput.value);
      }
    });
    
    // 初始化
    function init() {
      // 设置初始音量
      setVolume();
      
      // 调整画布尺寸
      resizeCanvas();
      
      // 创建背景粒子
      createBackgroundParticles();
      
      // 移动端友好提示：首次点击时激活音频上下文
      document.body.addEventListener('click', () => {
        if (audioContext && audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }, { once: true });
    }
    
    // 启动应用
    init();
  </script>
</body>
</html>
    