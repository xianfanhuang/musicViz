<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>可视化音乐应用</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
      touch-action: none;
    }
    canvas {
      display: block;
    }
    #info {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-family: sans-serif;
      font-size: 1.2em;
      text-align: center;
      opacity: 1;
      transition: opacity 1s ease-in-out;
    }
    #info.hidden {
      opacity: 0;
      pointer-events: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
</head>
<body>
  <div id="info">点击屏幕以开始</div>
  <script>
    // 应用状态变量
    let isPlaying = false;
    let isIdle = true;
    let lastActiveTime = 0;
    
    // Web Audio API 相关变量
    let audioCtx;
    let audioSource;
    let analyser;
    let bufferLength;
    let dataArray;
    
    // 用于存储实时音频数据
    let audioData = { bpm: 120, energy: 0.5 };
    
    // ----------------------------------------
    // p5.js 核心函数
    // ----------------------------------------
    function setup() {
      createCanvas(windowWidth, windowHeight);
      colorMode(HSL, 360, 100, 100, 1); // 设置为HSL颜色模式
      noLoop(); // 默认不循环，等待用户交互
    }
    
    function draw() {
      // 检查静默状态
      if (!isPlaying && millis() - lastActiveTime > 5000) {
        isIdle = true;
      }
      
      background(0, 0, 0, 1); // 黑色背景

      let scaleFactor = 1;
      let alpha = 0.5;
      let colorHue;

      if (isPlaying) {
        // 实时获取音频数据
        analyser.getByteFrequencyData(dataArray);

        // 计算能量（RMS）
        let sumOfSquares = 0;
        for (let i = 0; i < bufferLength; i++) {
          sumOfSquares += dataArray[i] * dataArray[i];
        }
        let energy = Math.sqrt(sumOfSquares / bufferLength) / 255;
        
        // 模拟BPM（用低频能量峰值来表示）
        let bassEnergy = (dataArray[0] + dataArray[1] + dataArray[2]) / 3 / 255;
        let bpm = map(bassEnergy, 0, 1, 60, 180);
        
        // 更新音频数据对象
        audioData.energy = energy;
        audioData.bpm = bpm;

        // 根据音乐数据驱动可视化
        let pulseSpeed = 60 / audioData.bpm;
        scaleFactor = 1 + audioData.energy * 0.2 * abs(sin(millis() / 1000 * PI / pulseSpeed));
        colorHue = map(audioData.energy, 0, 1, 200, 360);
        alpha = map(audioData.energy, 0, 1, 0.4, 0.9);
        
        document.getElementById('info').classList.add('hidden');
        
      } else if (isIdle) {
        // 静默状态：缓慢呼吸
        let breatheSpeed = 0.0003;
        scaleFactor = 1 + 0.05 * abs(sin(millis() * breatheSpeed));
        alpha = 0.2 + 0.1 * abs(sin(millis() * breatheSpeed));
        colorHue = 200;
        
        document.getElementById('info').classList.remove('hidden');

      } else {
        // 暂停状态：柔和呼吸
        scaleFactor = 1;
        alpha = 0.4;
        colorHue = 220;
        
        document.getElementById('info').classList.remove('hidden');
      }

      // 绘制核心图形
      translate(width / 2, height / 2);
      noFill();
      strokeWeight(5);
      stroke(colorHue, 100, 100, alpha);

      let numCircles = 15;
      for (let i = 0; i < numCircles; i++) {
        let currentScale = scaleFactor * (1 + i * 0.05);
        circle(0, 0, 100 * currentScale * (1 - i / numCircles));
      }

      requestAnimationFrame(draw); // 递归调用draw，实现动画循环
    }

    // ----------------------------------------
    // 交互与音频控制
    // ----------------------------------------
    function touchStarted() {
      if (!audioCtx) {
        initAudio();
        loop(); // 首次点击，启动 p5.js 循环
      }
      
      // 切换播放状态
      if (audioCtx.state === 'running') {
        audioCtx.suspend().then(() => {
          isPlaying = false;
        });
      } else {
        audioCtx.resume().then(() => {
          isPlaying = true;
          loop(); // 恢复p5.js循环
        });
      }
      
      lastActiveTime = millis();
      return false; // 阻止默认行为
    }

    // 初始化音频管道
    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      
      analyser.fftSize = 256;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      
      // 加载一个公共域的音乐文件
      const audio = new Audio('https://ia800300.us.archive.org/11/items/SilentNight_663/Silent_Night.mp3');
      audio.crossOrigin = 'anonymous';
      audio.loop = true; // 循环播放
      audio.play();

      audioSource = audioCtx.createMediaElementSource(audio);
      audioSource.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    
    // 窗口大小改变时重置画布
    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
