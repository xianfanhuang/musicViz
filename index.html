<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐解析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.1), 0 8px 10px -6px rgba(99, 102, 241, 0.1);
            }
        }
    </style>
</head>
<body class="bg-slate-100 font-inter min-h-screen">
    <!-- 顶部导航 -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fa fa-music text-2xl"></i>
                    <h1 class="text-2xl font-bold">音乐解析工具</h1>
                </div>
                <div>
                    <a href="https://github.com" target="_blank" class="flex items-center gap-1 bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full text-sm transition-colors">
                        <i class="fa fa-github"></i>
                        <span>GitHub</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 解析表单 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold mb-6 text-dark">解析音乐</h2>
                
                <div class="space-y-4">
                    <!-- 平台选择 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">选择音乐平台</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <button data-platform="netease" class="platform-btn bg-primary text-white py-2 px-3 rounded-lg flex flex-col items-center">
                                <i class="fa fa-music text-xl mb-1"></i>
                                <span class="text-sm">网易云</span>
                            </button>
                            <button data-platform="qq" class="platform-btn bg-slate-200 hover:bg-slate-300 text-slate-800 py-2 px-3 rounded-lg flex flex-col items-center transition-colors">
                                <i class="fa fa-qq text-xl mb-1"></i>
                                <span class="text-sm">QQ音乐</span>
                            </button>
                            <button data-platform="kuwo" class="platform-btn bg-slate-200 hover:bg-slate-300 text-slate-800 py-2 px-3 rounded-lg flex flex-col items-center transition-colors">
                                <i class="fa fa-headphones text-xl mb-1"></i>
                                <span class="text-sm">酷我音乐</span>
                            </button>
                            <button data-platform="kugou" class="platform-btn bg-slate-200 hover:bg-slate-300 text-slate-800 py-2 px-3 rounded-lg flex flex-col items-center transition-colors">
                                <i class="fa fa-microphone text-xl mb-1"></i>
                                <span class="text-sm">酷狗音乐</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 链接输入 -->
                    <div>
                        <label for="musicUrl" class="block text-sm font-medium text-slate-700 mb-1">音乐链接或ID</label>
                        <div class="flex gap-2">
                            <input type="text" id="musicUrl" placeholder="输入歌曲/专辑/歌单链接或ID..." 
                                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                            <button id="parseBtn" class="gradient-bg hover:opacity-90 text-white px-4 py-2 rounded-lg transition-all">
                                <i class="fa fa-search mr-1"></i>解析
                            </button>
                        </div>
                    </div>
                    
                    <!-- 音质选择 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">选择音质</label>
                        <div class="flex gap-2">
                            <button data-quality="standard" class="quality-btn bg-primary text-white py-1.5 px-3 rounded-lg text-sm">
                                标准音质
                            </button>
                            <button data-quality="high" class="quality-btn bg-slate-200 hover:bg-slate-300 text-slate-800 py-1.5 px-3 rounded-lg text-sm transition-colors">
                                高品质
                            </button>
                            <button data-quality="lossless" class="quality-btn bg-slate-200 hover:bg-slate-300 text-slate-800 py-1.5 px-3 rounded-lg text-sm transition-colors">
                                无损音质
                            </button>
                        </div>
                    </div>
                    
                    <!-- 后端API设置（部署后需要修改为实际后端地址） -->
                    <div class="bg-slate-50 p-3 rounded-lg">
                        <label for="apiEndpoint" class="block text-xs font-medium text-slate-600 mb-1">后端API地址（部署后修改）</label>
                        <input type="text" id="apiEndpoint" value="https://your-backend-url.vercel.app/api/parse" 
                            class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        <p class="text-xs text-slate-500 mt-1">后端服务需部署到Vercel/Netlify等平台</p>
                    </div>
                </div>
            </div>
            
            <!-- 加载状态 -->
            <div id="loading" class="bg-white rounded-xl shadow-md p-8 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
                <p class="text-slate-700">正在解析，请稍候...</p>
            </div>
            
            <!-- 错误提示 -->
            <div id="error" class="bg-red-50 border border-red-200 rounded-xl p-6 hidden">
                <div class="flex items-start">
                    <i class="fa fa-exclamation-circle text-red-500 mt-0.5 mr-3 text-xl"></i>
                    <div>
                        <h3 class="font-medium text-red-800 mb-1">解析失败</h3>
                        <p id="errorMessage" class="text-red-700 text-sm">请检查链接是否正确或尝试其他平台</p>
                    </div>
                </div>
            </div>
            
            <!-- 解析结果 -->
            <div id="result" class="hidden">
                <!-- 专辑/歌单信息 -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/4">
                            <img id="resultCover" src="https://picsum.photos/300/300" alt="封面" class="rounded-lg w-full object-cover aspect-square shadow-md">
                        </div>
                        <div class="md:w-3/4">
                            <h2 id="resultTitle" class="text-2xl font-bold text-dark mb-2"></h2>
                            <p id="resultArtist" class="text-slate-600 mb-3"></p>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span id="resultDate" class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full"></span>
                                <span id="resultCount" class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full"></span>
                            </div>
                            <p id="resultDescription" class="text-slate-600 text-sm line-clamp-3"></p>
                        </div>
                    </div>
                </div>
                
                <!-- 歌曲列表 -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="font-bold text-dark">歌曲列表</h3>
                    </div>
                    <div id="songsList" class="divide-y divide-slate-100">
                        <!-- 歌曲项将通过JS动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 解析历史 -->
            <div class="mt-8">
                <h2 class="text-xl font-bold mb-4 text-dark">解析历史</h2>
                <div id="historyList" class="grid grid-cols-1 gap-3">
                    <!-- 历史记录将通过JS动态生成 -->
                    <div class="text-center text-slate-500 py-6">
                        暂无解析历史
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-sm text-slate-400">
                <p>音乐解析工具 &copy; 2023</p>
                <p class="mt-1">仅用于技术研究，请勿用于商业用途</p>
            </div>
        </div>
    </footer>

    <script>
        // DOM元素
        const platformBtns = document.querySelectorAll('.platform-btn');
        const qualityBtns = document.querySelectorAll('.quality-btn');
        const musicUrlInput = document.getElementById('musicUrl');
        const parseBtn = document.getElementById('parseBtn');
        const apiEndpointInput = document.getElementById('apiEndpoint');
        const loadingIndicator = document.getElementById('loading');
        const errorIndicator = document.getElementById('error');
        const errorMessageEl = document.getElementById('errorMessage');
        const resultContainer = document.getElementById('result');
        const resultTitle = document.getElementById('resultTitle');
        const resultArtist = document.getElementById('resultArtist');
        const resultCover = document.getElementById('resultCover');
        const resultDate = document.getElementById('resultDate');
        const resultCount = document.getElementById('resultCount');
        const resultDescription = document.getElementById('resultDescription');
        const songsList = document.getElementById('songsList');
        const historyList = document.getElementById('historyList');
        
        // 状态变量
        let selectedPlatform = 'netease';
        let selectedQuality = 'standard';
        let parseHistory = JSON.parse(localStorage.getItem('parseHistory') || '[]');
        
        // 格式化时间
        function formatTime(milliseconds) {
            if (!milliseconds) return '00:00';
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024 * 1024) {
                return `${(bytes / 1024).toFixed(1)} KB`;
            } else {
                return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
            }
        }
        
        // 平台选择
        platformBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // 重置所有按钮样式
                platformBtns.forEach(b => {
                    b.classList.remove('bg-primary', 'text-white');
                    b.classList.add('bg-slate-200', 'hover:bg-slate-300', 'text-slate-800');
                });
                
                // 设置当前按钮样式
                btn.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'text-slate-800');
                btn.classList.add('bg-primary', 'text-white');
                
                // 更新选中的平台
                selectedPlatform = btn.dataset.platform;
            });
        });
        
        // 音质选择
        qualityBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // 重置所有按钮样式
                qualityBtns.forEach(b => {
                    b.classList.remove('bg-primary', 'text-white');
                    b.classList.add('bg-slate-200', 'hover:bg-slate-300', 'text-slate-800');
                });
                
                // 设置当前按钮样式
                btn.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'text-slate-800');
                btn.classList.add('bg-primary', 'text-white');
                
                // 更新选中的音质
                selectedQuality = btn.dataset.quality;
            });
        });
        
        // 解析音乐
        parseBtn.addEventListener('click', async () => {
            const url = musicUrlInput.value.trim();
            const apiEndpoint = apiEndpointInput.value.trim();
            
            if (!url) {
                showError('请输入音乐链接或ID');
                return;
            }
            
            if (!apiEndpoint) {
                showError('请设置后端API地址');
                return;
            }
            
            try {
                // 显示加载状态
                showLoading();
                
                // 调用后端API
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        platform: selectedPlatform,
                        quality: selectedQuality
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 显示解析结果
                    displayResult(result.data);
                    
                    // 保存到历史记录
                    saveToHistory({
                        url: url,
                        platform: selectedPlatform,
                        title: result.data.title,
                        artist: result.data.artist,
                        cover: result.data.cover,
                        timestamp: new Date().getTime()
                    });
                } else {
                    showError(result.message || '解析失败，请重试');
                }
            } catch (error) {
                console.error('解析错误:', error);
                showError('网络错误，请检查API地址是否正确或稍后重试');
            }
        });
        
        // 显示加载状态
        function showLoading() {
            errorIndicator.classList.add('hidden');
            resultContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
        }
        
        // 显示错误信息
        function showError(message) {
            loadingIndicator.classList.add('hidden');
            resultContainer.classList.add('hidden');
            errorMessageEl.textContent = message;
            errorIndicator.classList.remove('hidden');
        }
        
        // 显示解析结果
        function displayResult(data) {
            loadingIndicator.classList.add('hidden');
            errorIndicator.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            
            // 填充基本信息
            resultTitle.textContent = data.title || '未知标题';
            resultArtist.textContent = data.artist || '未知艺术家';
            resultCover.src = data.cover || 'https://picsum.photos/300/300';
            resultCover.alt = data.title || '封面';
            resultDate.textContent = data.publishDate || '未知日期';
            resultCount.textContent = `共 ${data.songs.length} 首歌曲`;
            resultDescription.textContent = data.description || '无描述';
            
            // 清空歌曲列表
            songsList.innerHTML = '';
            
            // 填充歌曲列表
            data.songs.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'p-4 hover:bg-slate-50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 card-hover';
                
                // 歌曲信息
                let songInfo = `
                    <div class="flex items-center gap-3 flex-1">
                        <span class="w-6 h-6 rounded-full bg-primary/10 text-primary flex items-center justify-center text-sm">${index + 1}</span>
                        <div>
                            <h4 class="font-medium text-slate-800">${song.title}</h4>
                            <p class="text-sm text-slate-500">${song.artist}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-end">
                        <span class="text-sm text-slate-500">${formatTime(song.duration)}</span>
                        <span class="text-sm text-slate-500">${formatFileSize(song.size)}</span>
                `;
                
                // 播放和下载按钮
                if (song.url) {
                    songInfo += `
                        <button class="play-btn bg-primary/10 hover:bg-primary/20 text-primary p-2 rounded-full transition-colors" 
                                data-url="${song.url}" data-title="${song.title}">
                            <i class="fa fa-play"></i>
                        </button>
                        <a href="${song.url}" target="_blank" download="${song.title}.mp3" 
                           class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-2 rounded-full transition-colors">
                            <i class="fa fa-download"></i>
                        </a>
                    `;
                } else {
                    songInfo += `
                        <span class="text-xs text-red-500">${song.error || '无法获取'}</span>
                    `;
                }
                
                songInfo += `</div>`;
                songItem.innerHTML = songInfo;
                songsList.appendChild(songItem);
            });
            
            // 添加播放按钮事件
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.dataset.url;
                    const title = this.dataset.title;
                    playAudio(url, title);
                });
            });
        }
        
        // 播放音频
        function playAudio(url, title) {
            // 检查是否已有音频播放器
            let audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.remove();
            }
            
            // 创建新的音频播放器
            audioPlayer = document.createElement('div');
            audioPlayer.id = 'audioPlayer';
            audioPlayer.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white shadow-lg rounded-full p-3 flex items-center gap-3 z-50 max-w-md w-full';
            audioPlayer.innerHTML = `
                <audio id="audioElement" src="${url}" controls class="flex-1"></audio>
                <button id="closeAudio" class="text-slate-500 hover:text-slate-700 p-1">
                    <i class="fa fa-times"></i>
                </button>
            `;
            document.body.appendChild(audioPlayer);
            
            // 自动播放
            document.getElementById('audioElement').play().catch(e => {
                console.log('自动播放失败，需要用户交互:', e);
            });
            
            // 关闭按钮事件
            document.getElementById('closeAudio').addEventListener('click', () => {
                audioPlayer.remove();
            });
        }
        
        // 保存到历史记录
        function saveToHistory(item) {
            // 限制历史记录数量
            parseHistory.unshift(item);
            if (parseHistory.length > 10) {
                parseHistory = parseHistory.slice(0, 10);
            }
            
            // 保存到本地存储
            localStorage.setItem('parseHistory', JSON.stringify(parseHistory));
            
            // 更新历史记录显示
            displayHistory();
        }
        
        // 显示历史记录
        function displayHistory() {
            if (parseHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center text-slate-500 py-6">
                        暂无解析历史
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = '';
            
            parseHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white rounded-lg shadow-sm p-3 flex items-center gap-3 card-hover';
                
                // 平台图标
                let platformIcon = 'fa-music';
                if (item.platform === 'qq') platformIcon = 'fa-qq';
                if (item.platform === 'kuwo') platformIcon = 'fa-headphones';
                if (item.platform === 'kugou') platformIcon = 'fa-microphone';
                
                historyItem.innerHTML = `
                    <img src="${item.cover || 'https://picsum.photos/60/60'}" alt="封面" class="w-12 h-12 rounded object-cover">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-slate-800 truncate">${item.title}</h4>
                        <p class="text-sm text-slate-500 truncate">${item.artist}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400">
                            <i class="${platformIcon} mr-1"></i>
                            ${formatDate(item.timestamp)}
                        </span>
                        <button class="reparse-btn text-slate-400 hover:text-primary p-1" 
                                data-url="${item.url}" data-platform="${item.platform}">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button class="delete-history-btn text-slate-400 hover:text-red-500 p-1" 
                                data-index="${index}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            // 添加重新解析事件
            document.querySelectorAll('.reparse-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.dataset.url;
                    const platform = this.dataset.platform;
                    
                    // 填充表单
                    musicUrlInput.value = url;
                    
                    // 选择平台
                    platformBtns.forEach(b => {
                        if (b.dataset.platform === platform) {
                            b.click(); // 触发点击事件，更新样式和状态
                        }
                    });
                    
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
            
            // 添加删除历史事件
            document.querySelectorAll('.delete-history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    parseHistory.splice(index, 1);
                    localStorage.setItem('parseHistory', JSON.stringify(parseHistory));
                    displayHistory();
                });
            });
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        // 初始化
        function init() {
            // 显示历史记录
            displayHistory();
            
            // 从URL参数加载链接（如果有）
            const params = new URLSearchParams(window.location.search);
            const urlParam = params.get('url');
            if (urlParam) {
                musicUrlInput.value = urlParam;
            }
        }
        
        // 启动应用
        init();
    </script>
</body>
</html>
    